{% extends 'global/base.html' %} 
{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-plus-circle"></i> Solicitar Novo Orçamento
        </h1>
    </div>
</div>

<!-- MOSTRAR ERROS -->
{% if orcamento_form.errors or item_formset.errors %}
<div class="alert alert-danger">
    <h5>Erro no formulário!</h5>
    <ul>
        {% for field in orcamento_form %}
            {% for error in field.errors %}
                <li>{{ field.label }}: {{ error }}</li>
            {% endfor %}
        {% endfor %}
        {% for form in item_formset %}
            {% for field in form %}
                {% for error in field.errors %}
                    <li>{{ field.label }}: {{ error }}</li>
                {% endfor %}
            {% endfor %}
        {% endfor %}
    </ul>
</div>
{% endif %}

<form method="post" enctype="multipart/form-data" id="orcamento-form">
    {% csrf_token %}
    
    <!-- Informações Gerais -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-info-circle"></i> Informações Gerais</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating mb-3">
                        {{ orcamento_form.data_maxima_entrega }}
                        <label for="{{ orcamento_form.data_maxima_entrega.id_for_label }}">Data Máxima para Entrega</label>
                    </div>
                </div>
            </div>
            <div class="form-floating">
                {{ orcamento_form.observacoes_cliente }}
                <label for="{{ orcamento_form.observacoes_cliente.id_for_label }}">Observações Gerais</label>
            </div>
        </div>
    </div>

    <!-- Produtos -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-box"></i> Produtos</h5>
            
        </div>
        <div class="card-body">
            <div id="itens-container">
                {{ item_formset.management_form }}
                {% for form in item_formset %}
                    <div class="item-orcamento border p-3 mb-3 rounded" data-form-index="{{ forloop.counter0 }}">
                        {% for field in form %}
                            {% if field.name != 'DELETE' %}
                                <div class="mb-3">
                                    <label class="form-label">{{ field.label }}</label>
                                    {{ field }}
                                    {% if field.help_text %}
                                        <div class="form-text">{{ field.help_text }}</div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}
                        
                        <!-- Preview do Produto -->
                        <div class="produto-info alert alert-light mt-3" id="produto-info-{{ forloop.counter0 }}" style="display: none;">
                            <!-- Será preenchido pelo JavaScript -->
                        </div>
                        
                        <!-- Preview dos Arquivos -->
                        <div id="arquivos-preview-{{ forloop.counter0 }}" class="mt-3"></div>
                        
                        <div class="text-end mt-3">
                            <button type="button" class="btn btn-outline-danger btn-sm btn-remover-item">
                                <i class="bi bi-trash"></i> Remover
                            </button>
                        </div>
                        
                        {{ form.DELETE }}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Botões -->
    <div class="d-flex justify-content-between">
        <a href="{% url 'naya_site:dashboard' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar
        </a>
        <button type="button" class="btn btn-success btn-sm" id="btn-adicionar-item">
            <i class="bi bi-plus"></i> Adicionar Produto
        </button>
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="bi bi-send"></i> Solicitar Orçamento
        </button>
    </div>
</form>

{% endblock %}

{% block extra_js %}
<script>
let formIndex = {{ item_formset|length }};

// Função para carregar preview do produto
function carregarPreview(produtoId, index) {
    const previewDiv = document.getElementById('produto-info-' + index);
    if (!previewDiv || !produtoId) {
        if (previewDiv) previewDiv.style.display = 'none';
        return;
    }

    const url = '/api/product/' + produtoId + '/';
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            previewDiv.innerHTML = `
                <div class="row align-items-center">
                    <div class="col-3">
                        <img src="${data.imagem || '/static/img/no-image.png'}" 
                             class="img-fluid rounded border" 
                             style="max-height: 70px; object-fit: cover;"
                             onerror="this.src='/static/img/no-image.png'">
                    </div>
                    <div class="col-9">
                        <h6 class="mb-1 text-primary"><strong>${data.nome}</strong></h6>
                        <p class="mb-1 small text-muted"><strong>Categoria:</strong> ${data.categoria}</p>
                        <p class="mb-0 text-success"><strong>R$ ${data.preco_base?.toFixed(2) || '0,00'}</strong></p>
                    </div>
                </div>
            `;
            previewDiv.style.display = 'block';
        })
        .catch(error => {
            previewDiv.innerHTML = '<div class="alert alert-danger">Erro ao carregar</div>';
            previewDiv.style.display = 'block';
        });

    previewDiv.innerHTML = '<div class="text-info">Carregando...</div>';
    previewDiv.style.display = 'block';
}

// FUNÇÃO ADICIONAR ITEM - SIMPLIFICADA
function adicionarItem() {
    
    const container = document.getElementById('itens-container');
    const itens = container.querySelectorAll('.item-orcamento');
    
    if (itens.length === 0) {
        alert('Erro: Nenhum item para clonar');
        return;
    }

    // Clonar o primeiro item
    const novoItem = itens[0].cloneNode(true);
    const novoIndex = formIndex++;

    // Atualizar data-form-index
    novoItem.setAttribute('data-form-index', novoIndex);

    // Atualizar todos os names e IDs
    novoItem.querySelectorAll('[name]').forEach(campo => {
        const nomeAntigo = campo.getAttribute('name');
        if (nomeAntigo) {
            const nomeNovo = nomeAntigo.replace(/-(\d+)-/, `-${novoIndex}-`);
            campo.setAttribute('name', nomeNovo);
            campo.id = 'id_' + nomeNovo;
        }
    });

    // Limpar valores
    novoItem.querySelectorAll('input, select, textarea').forEach(campo => {
        if (campo.type !== 'hidden') {
            campo.value = '';
        }
    });

    // Limpar e atualizar previews
    const previewProduto = novoItem.querySelector('.produto-info');
    if (previewProduto) {
        previewProduto.innerHTML = '';
        previewProduto.style.display = 'none';
        previewProduto.id = 'produto-info-' + novoIndex;
    }

    const previewArquivos = novoItem.querySelector('[id^="arquivos-preview-"]');
    if (previewArquivos) {
        previewArquivos.innerHTML = '';
        previewArquivos.id = 'arquivos-preview-' + novoIndex;
    }

    // Atualizar TOTAL_FORMS
    const totalForms = document.getElementById('id_form-TOTAL_FORMS');
    if (totalForms) {
        totalForms.value = formIndex;
    }

    // Adicionar ao container
    container.appendChild(novoItem);
}

// FUNÇÃO REMOVER ITEM - SIMPLIFICADA
function removerItem(button) {
    
    if (!confirm('Tem certeza que deseja remover este item?')) {
        return;
    }
    
    const item = button.closest('.item-orcamento');
    if (!item) {
        console.error('Item não encontrado');
        return;
    }
    
    // REMOVER COMPLETAMENTE em vez de ocultar
    item.remove();
    
    // Atualizar o índice do formIndex se necessário
    formIndex--;
}

// CONFIGURAÇÃO DOS EVENTOS - DIRETA
document.addEventListener('DOMContentLoaded', function() {

    // 1. Botão Adicionar Item
    const btnAdicionar = document.getElementById('btn-adicionar-item');
    if (btnAdicionar) {
        btnAdicionar.onclick = adicionarItem;
    }

    // 2. Evento para selects de produto (DELEGAÇÃO)
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('produto-select')) {
            const produtoId = e.target.value;
            const item = e.target.closest('.item-orcamento');
            const index = item ? item.getAttribute('data-form-index') : '0';
            carregarPreview(produtoId, index);
        }
    });

    // 3. Evento para botões remover (DELEGAÇÃO)
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('btn-remover-item')) {
            removerItem(e.target);
        }
    });

    // 4. Validação do formulário
    const form = document.getElementById('orcamento-form');
    if (form) {
        form.onsubmit = function(e) {
            const itensVisiveis = document.querySelectorAll('.item-orcamento:not([style*="display: none"])');
            
            if (itensVisiveis.length === 0) {
                e.preventDefault();
                alert('❌ Adicione pelo menos um produto ao orçamento.');
                return false;
            }
            
            let todosComProduto = true;
            itensVisiveis.forEach(item => {
                const select = item.querySelector('.produto-select');
                if (!select || !select.value) {
                    todosComProduto = false;
                }
            });
            
            if (!todosComProduto) {
                e.preventDefault();
                alert('❌ Selecione um produto para todos os itens.');
                return false;
            }
            
            return true;
        };
    }
});
</script>
{% endblock %}
