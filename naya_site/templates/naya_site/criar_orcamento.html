{% extends 'global/base.html' %} 
{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-plus-circle"></i> Solicitar Novo Orçamento
        </h1>
    </div>
</div>

<!-- MOSTRAR ERROS -->
{% if orcamento_form.errors or item_formset.errors %}
<div class="alert alert-danger">
    <h5>Erro no formulário!</h5>
    <ul>
        {% for field in orcamento_form %}
            {% for error in field.errors %}
                <li>{{ field.label }}: {{ error }}</li>
            {% endfor %}
        {% endfor %}
        {% for form in item_formset %}
            {% for field in form %}
                {% for error in field.errors %}
                    <li>{{ field.label }}: {{ error }}</li>
                {% endfor %}
            {% endfor %}
        {% endfor %}
    </ul>
</div>
{% endif %}

<form method="post" enctype="multipart/form-data" id="orcamento-form">
    {% csrf_token %}
    
    <!-- Informações Gerais -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-info-circle"></i> Informações Gerais</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating mb-3">
                        {{ orcamento_form.data_maxima_entrega }}
                        <label for="{{ orcamento_form.data_maxima_entrega.id_for_label }}">Data Máxima para Entrega</label>
                    </div>
                </div>
            </div>
            <div class="form-floating">
                {{ orcamento_form.observacoes_cliente }}
                <label for="{{ orcamento_form.observacoes_cliente.id_for_label }}">Observações Gerais</label>
            </div>
        </div>
    </div>

    <!-- Produtos -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-box"></i> Produtos</h5>
            
        </div>
        <div class="card-body">
            <div id="itens-container">
                {{ item_formset.management_form }}
                {% for form in item_formset %}
                    <div class="item-orcamento border p-3 mb-3 rounded" data-form-index="{{ forloop.counter0 }}">
                        {% for field in form %}
                            {% if field.name != 'DELETE' %}
                                <div class="mb-3">
                                    <label class="form-label">{{ field.label }}</label>
                                    {{ field }}
                                    {% if field.help_text %}
                                        <div class="form-text">{{ field.help_text }}</div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}
                        
                        <!-- Preview do Produto -->
                        <div class="produto-info alert alert-light mt-3" id="produto-info-{{ forloop.counter0 }}" style="display: none;">
                            <!-- Será preenchido pelo JavaScript -->
                        </div>
                        
                        <!-- Preview dos Arquivos -->
                        <div id="arquivos-preview-{{ forloop.counter0 }}" class="mt-3"></div>
                        
                        <div class="text-end mt-3">
                            <button type="button" class="btn btn-outline-danger btn-sm btn-remover-item">
                                <i class="bi bi-trash"></i> Remover
                            </button>
                        </div>
                        
                        {{ form.DELETE }}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Botões -->
    <div class="d-flex justify-content-between">
        <a href="{% url 'naya_site:dashboard' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar
        </a>
        <button type="button" class="btn btn-success btn-sm" id="btn-adicionar-item">
            <i class="bi bi-plus"></i> Adicionar Produto
        </button>
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="bi bi-send"></i> Solicitar Orçamento
        </button>
    </div>
</form>

{% endblock %}

{% block extra_js %}
<script>
let formIndex = {{ item_formset|length }};

// Função principal para carregar preview
function carregarPreview(produtoId, index) {
        
    const previewDiv = document.getElementById('produto-info-' + index);
    if (!previewDiv) {
        return;
    }

    if (!produtoId) {
        previewDiv.style.display = 'none';
        return;
    }

    // URL da API - TESTE AMBAS
    const url1 = '/api/product/' + produtoId + '/';
    const url2 = '/naya_site/api/product/' + produtoId + '/';
        
    // Tentar primeira URL
    fetch(url1)
        .then(response => {
            if (response.ok) return response.json();
            return fetch(url2).then(r => {
                if (r.ok) return r.json();
                throw new Error('Ambas URLs falharam');
            });
        })
        .then(data => {
            mostrarPreview(data, previewDiv);
        })
        .catch(error => {
            previewDiv.innerHTML = '<div class="alert alert-danger">Erro ao carregar produto</div>';
            previewDiv.style.display = 'block';
        });

    previewDiv.innerHTML = '<div class="text-info">Carregando...</div>';
    previewDiv.style.display = 'block';
}

// Função para mostrar o preview
function mostrarPreview(dados, div) {
    const imagemUrl = dados.imagem || '/static/img/no-image.png';
    const nome = dados.nome || 'Produto sem nome';
    const categoria = dados.categoria || 'Sem categoria';
    const preco = dados.preco_base ? 'R$ ' + dados.preco_base.toFixed(2) : 'R$ 0,00';

    div.innerHTML = `
        <div class="row align-items-center">
            <div class="col-3">
                <img src="${imagemUrl}" alt="${nome}" 
                     class="img-fluid rounded border" 
                     style="max-height: 70px; object-fit: cover;"
                     onerror="this.src='/static/img/no-image.png'">
            </div>
            <div class="col-9">
                <h6 class="mb-1 text-primary"><strong>${nome}</strong></h6>
                <p class="mb-1 small text-muted"><strong>Categoria:</strong> ${categoria}</p>
                <p class="mb-0 text-success"><strong>${preco}</strong></p>
            </div>
        </div>
    `;
    div.style.display = 'block';
}

// Função para adicionar item
function adicionarItem() {
    
    const container = document.getElementById('itens-container');
    const totalForms = document.getElementById('id_form-TOTAL_FORMS');
    
    if (!container) {
        alert('Erro: Container não encontrado');
        return;
    }

    const itens = container.querySelectorAll('.item-orcamento');
    if (itens.length === 0) {
        alert('Erro: Nenhum item para clonar');
        return;
    }

    const novoIndex = formIndex++;
    const template = itens[0].cloneNode(true);

    // Atualizar índices
    template.setAttribute('data-form-index', novoIndex);
    
    // Atualizar names e IDs
    template.querySelectorAll('[name]').forEach(campo => {
        const nome = campo.getAttribute('name');
        if (nome) {
            const novoNome = nome.replace(/form-\d+/, 'form-' + novoIndex);
            campo.setAttribute('name', novoNome);
            campo.setAttribute('id', 'id_' + novoNome);
        }
    });

    // Limpar valores
    template.querySelectorAll('input, select, textarea').forEach(campo => {
        if (campo.type !== 'hidden') {
            campo.value = '';
        }
    });

    // Limpar preview
    const preview = template.querySelector('.produto-info');
    if (preview) {
        preview.innerHTML = '';
        preview.style.display = 'none';
        preview.id = 'produto-info-' + novoIndex;
    }

    // Limpar preview de arquivos
    const arquivosPreview = template.querySelector('[id^="arquivos-preview-"]');
    if (arquivosPreview) {
        arquivosPreview.innerHTML = '';
        arquivosPreview.id = 'arquivos-preview-' + novoIndex;
    }

    container.appendChild(template);
    totalForms.value = formIndex;
}

// Função para remover item
function removerItem(botao) {
    const item = botao.closest('.item-orcamento');
    const deleteInput = item.querySelector('input[name*="-DELETE"]');
    
    if (deleteInput) {
        deleteInput.checked = true;
        item.style.display = 'none';
    } else {
        item.remove();
        const totalForms = document.getElementById('id_form-TOTAL_FORMS');
        totalForms.value = parseInt(totalForms.value) - 1;
    }
}

// Configurar eventos quando página carregar
document.addEventListener('DOMContentLoaded', function() {
    // Botão adicionar
    document.getElementById('btn-adicionar-item').addEventListener('click', adicionarItem);

    // Evento para selects de produto
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('produto-select')) {
            const produtoId = e.target.value;
            const item = e.target.closest('.item-orcamento');
            const index = item ? item.getAttribute('data-form-index') : '0';
            
            carregarPreview(produtoId, index);
        }
    });

    // Evento para botões remover
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('btn-remover-item')) {
            removerItem(e.target);
        }
    });
});
</script>
{% endblock %}
